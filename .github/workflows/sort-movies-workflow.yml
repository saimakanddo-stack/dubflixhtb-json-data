# .github/workflows/sort-movies-workflow.yml
name: Auto-Sort Movies on Update

on:
  push:
    paths:
      - 'data/movies.json'
  pull_request:
    paths:
      - 'data/movies.json'
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ржЯрзНрж░рж┐ржЧрж╛рж░

jobs:
  sort-movies:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ржХржорж┐ржЯ ржПржмржВ ржкрзБрж╢ ржХрж░рж╛рж░ ржЕржирзБржорждрж┐
    
    steps:
    - name: рж░рж┐ржкрзЛржЬрж┐ржЯрж░рж┐ ржЪрзЗржХржЖржЙржЯ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Python рж╕рзЗржЯ ржЖржк ржХрж░рзБржи
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ржПржиржХрзЛржбрж┐ржВ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ рж╕рзЗржЯ ржХрж░рзБржи
      run: |
        # UTF-8 ржПржиржХрзЛржбрж┐ржВ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи
        echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV
        echo "LANG=C.UTF-8" >> $GITHUB_ENV
        echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV
    
    - name: ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ рж╕рзНржЯрзНрж░рж╛ржХржЪрж╛рж░ ржжрзЗржЦрзБржи
      run: |
        echo "ржмрж░рзНрждржорж╛ржи ржбрж┐рж░рзЗржХрзНржЯрж░рж┐:"
        pwd
        echo "ржлрж╛ржЗрж▓рж╕ржорзВрж╣:"
        ls -la
        echo "ржбрзЗржЯрж╛ ржбрж┐рж░рзЗржХрзНржЯрж░рж┐:"
        ls -la data/ || echo "ржбрзЗржЯрж╛ ржбрж┐рж░рзЗржХрзНржЯрж░рж┐ ржирзЗржЗ"
    
    - name: ржорзБржнрж┐ рж╕рж░рзНржЯрж╛рж░ рж░рж╛ржи ржХрж░рзБржи
      id: sorter
      env:
        PYTHONUTF8: 1  # Python 3.7+ ржПрж░ ржЬржирзНржп UTF-8 ржорзЛржб рж╕ржХрзНрж╖ржо ржХрж░рзБржи
      run: |
        # ржлрж┐ржХрзНрж╕ржб ржнрж╛рж░рзНрж╕ржи рж░рж╛ржи ржХрж░рзБржи
        python scripts/sort_movies_fixed.py
    
    - name: ржкрж░рж┐ржмрж░рзНрждржи ржЪрзЗржХ ржХрж░рзБржи
      id: changes
      run: |
        # movies.json ржлрж╛ржЗрж▓рзЗ ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи
        if git diff --name-only | grep -q "data/movies.json"; then
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "тЬЕ movies.json ржлрж╛ржЗрж▓рзЗ ржкрж░рж┐ржмрж░рзНрждржи рж╕ржирж╛ржХрзНржд ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ"
          echo "ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд:"
          git diff --stat data/movies.json
        else
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "тД╣я╕П movies.json ржлрж╛ржЗрж▓рзЗ ржХрзЛржирзЛ ржкрж░рж┐ржмрж░рзНрждржи ржирзЗржЗ"
        fi
    
    - name: ржкрж░рж┐ржмрж░рзНрждржи ржХржорж┐ржЯ ржПржмржВ ржкрзБрж╢ ржХрж░рзБржи
      if: steps.changes.outputs.changes == 'true'
      run: |
        # Git ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # UTF-8 рж╕рж╛ржкрзЛрж░рзНржЯ рж╕ржХрзНрж╖ржо ржХрж░рзБржи
        git config --global core.quotepath false
        
        # ржкрж░рж┐ржмрж░рзНрждржи ржпрзЛржЧ ржХрж░рзБржи
        git add data/movies.json
        
        # ржХржорж┐ржЯ ржХрж░рзБржи
        git commit -m "ЁЯОм Auto-sort: Movies sorted by most recent activity"
        
        echo "ржХржорж┐ржЯ рж▓ржЧ:"
        git log --oneline -5
        
        # ржкрзБрж╢ ржХрж░рзБржи (рж░рж┐ржЯрзНрж░рж┐ рж▓ржЬрж┐ржХ рж╕рж╣)
        for attempt in 1 2 3; do
          echo "ржкрзБрж╢ ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ #${attempt}..."
          if git push; then
            echo "тЬЕ ржкрзБрж╢ рж╕ржлрж▓!"
            break
          else
            echo "тЭМ ржкрзБрж╢ ржмрзНржпрж░рзНрже, рзл рж╕рзЗржХрзЗржирзНржб ржкрж░ ржкрзБржирж░рж╛ржпрж╝ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
            sleep 5
            # рж╕рж░рзНржмрж╢рзЗрж╖ ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рзЛ ржлрзЗржЪ ржХрж░рзБржи
            git pull --rebase
          fi
        done
    
    - name: рж╕ржорзНржкрзВрж░рзНржг рж░рж┐ржкрзЛрж░рзНржЯ
      run: |
        echo "========================================="
        echo "         GitHub Action рж░рж┐ржкрзЛрж░рзНржЯ         "
        echo "========================================="
        echo "ржЬржм: sort-movies"
        echo "рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕: ${{ job.status }}"
        echo "ржкрж░рж┐ржмрж░рзНрждржи: ${{ steps.changes.outputs.changes }}"
        echo "========================================="

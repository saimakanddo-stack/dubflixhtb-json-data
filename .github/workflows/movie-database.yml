name: Movie Database Manager

on:
  # ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤: ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶Ø‡¶º
  schedule:
    - cron: '0 */4 * * *'
  
  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger'
  
  # movies.json ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá
  push:
    branches:
      - main
    paths:
      - 'data/movies.json'
  
  # Pull request ‡¶è movies.json ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶≤‡ßá
  pull_request:
    branches:
      - main
    paths:
      - 'data/movies.json'

# ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ main ‡¶¨‡ßç‡¶∞‡¶æ‡¶û‡ßç‡¶ö‡ßá ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá
jobs:
  validate-and-process:
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    # ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º permissions
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Validate JSON structure
        run: |
          echo "üîç Validating movies.json structure..."
          node -e "
            const fs = require('fs');
            try {
              const data = JSON.parse(fs.readFileSync('data/movies.json', 'utf8'));
              if (!Array.isArray(data)) {
                console.error('‚ùå Error: movies.json should contain an array');
                process.exit(1);
              }
              console.log('‚úÖ JSON structure is valid');
              console.log('üìä Total movies found:', data.length);
            } catch (error) {
              console.error('‚ùå Invalid JSON:', error.message);
              process.exit(1);
            }
          "
      
      - name: Process movies.json
        id: process
        run: |
          echo "üîÑ Processing movies..."
          OUTPUT=$(node .github/scripts/process-movies.js 2>&1)
          echo "$OUTPUT"
          
          # Exit code ‡¶•‡ßá‡¶ï‡ßá changes made ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ
          EXIT_CODE=$?
          if [ $EXIT_CODE -eq 0 ]; then
            echo "CHANGES_MADE=true" >> $GITHUB_OUTPUT
            echo "::set-output name=changes_made::true"
          else
            echo "CHANGES_MADE=false" >> $GITHUB_OUTPUT
            echo "::set-output name=changes_made::false"
          fi
      
      - name: Create Summary
        run: |
          echo "## üé¨ Movie Processing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Processing Details:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ JSON validation passed" >> $GITHUB_STEP_SUMMARY
          echo "- üîÑ Movies processed successfully" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.process.outputs.changes_made }}" == "true" ]]; then
            echo "- üéâ **Changes were made to movies.json**" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ‚è≠Ô∏è No changes needed" >> $GITHUB_STEP_SUMMARY
          fi
      
      # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ main ‡¶¨‡ßç‡¶∞‡¶æ‡¶û‡ßç‡¶ö‡ßá ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø push ‡¶ï‡¶∞‡¶¨‡ßá
      - name: Auto Commit & Push Changes (Main Branch Only)
        if: github.ref == 'refs/heads/main' && steps.process.outputs.changes_made == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # Commit message
          commit_message: |
            ü§ñ Auto-update: Processed movies.json
            
            - Updated date formats to ISO 8601
            - Refreshed status labels (NEW/UPDATED)
            - Sorted by most recent dates
            - Automated processing completed
            
            [skip ci]
          
          # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ movies.json ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
          file_pattern: |
            data/movies.json
          
          # ‡¶ï‡¶Æ‡¶ø‡¶ü‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø
          commit_user_name: "Movie Database Bot"
          commit_user_email: "movie-bot@users.noreply.github.com"
          
          # Branch
          branch: main
          
          # Optional settings
          commit_options: '--no-verify --signoff'
          skip_fetch: false
          skip_checkout: false
          status_options: '--untracked-files=no'
      
      # Pull request ‡¶è‡¶∞ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡ßá ‡¶ï‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá
      - name: Comment on Pull Request
        if: github.event_name == 'pull_request' && steps.process.outputs.changes_made == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
            });
            
            const botCommentExists = comments.some(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Movie Database Bot')
            );
            
            if (!botCommentExists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ü§ñ **Movie Database Bot Notification**\n\nChanges were automatically applied to \`movies.json\`:\n- Dates converted to ISO 8601 format\n- Status labels updated (NEW/UPDATED)\n- Movies sorted by most recent dates\n\nPlease review the changes before merging.`
              });
            }
      
      - name: Show Final Status
        run: |
          if [[ "${{ steps.process.outputs.changes_made }}" == "true" ]]; then
            echo "‚úÖ Changes were detected and processed"
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "üöÄ Changes have been committed to main branch"
            fi
          else
            echo "‚ÑπÔ∏è No changes were needed"
          fi

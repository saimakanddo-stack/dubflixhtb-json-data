name: Process Movies JSON

on:
  push:
    paths:
      - 'data/movies.json'
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'  # ржкрзНрж░рждрж┐ рзйрзж ржорж┐ржирж┐ржЯрзЗ

jobs:
  process-movies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Process JSON data
      run: |
        echo "JSON ржбрзЗржЯрж╛ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╢рзБрж░рзБ рж╣ржЪрзНржЫрзЗ..."
        
        # ржкрзНрж░рж╛ржержорж┐ржХ ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи
        current_date=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        cache_timestamp=$(date +%s)
        
        # movies.json ржлрж╛ржЗрж▓ ржкржбрж╝рзБржи
        if [ -f "data/movies.json" ]; then
          echo "movies.json ржлрж╛ржЗрж▓ ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗ"
          
          # JSON ржкрзНрж░рж╕рзЗрж╕ ржХрж░рж╛рж░ ржЬржирзНржп Node.js рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рждрзИрж░рж┐ ржХрж░рзБржи
          cat > process.js << 'EOF'
        const fs = require('fs');
        const path = require('path');

        // ржлрж╛ржЗрж▓ ржкрж╛рже
        const inputFile = path.join(__dirname, 'data/movies.json');
        const outputFile = path.join(__dirname, 'data/movies_processed.json');

        try {
          // JSON ржлрж╛ржЗрж▓ ржкржбрж╝рзБржи
          const rawData = fs.readFileSync(inputFile, 'utf8');
          let movies = JSON.parse(rawData);
          
          console.log(`ржорзЛржЯ ${movies.length} ржЯрж┐ ржорзБржнрж┐ ржкрж╛ржУржпрж╝рж╛ ржЧрзЗржЫрзЗ`);
          
          // ржмрж░рзНрждржорж╛ржи рж╕ржоржпрж╝
          const now = new Date();
          const sevenDaysAgo = new Date(now);
          sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
          
          // ржкрзНрж░рждрж┐ржЯрж┐ ржорзБржнрж┐ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рзБржи
          movies.forEach((movie, index) => {
            // 1. info1_custom ржлрж┐рж▓рзНржб ржбрж╛ржЗржирж╛ржорж┐ржХржнрж╛ржмрзЗ ржЖржкржбрзЗржЯ ржХрж░рзБржи
            const createdAt = movie.createdAt ? new Date(movie.createdAt) : null;
            const lastUpdated = movie.lastUpdated ? new Date(movie.lastUpdated) : null;
            
            let status = '';
            
            if (createdAt && createdAt >= sevenDaysAgo) {
              // рзн ржжрж┐ржирзЗрж░ ржоржзрзНржпрзЗ рждрзИрж░рж┐
              status = "NEW";
            } else if (lastUpdated && lastUpdated >= sevenDaysAgo) {
              // рзн ржжрж┐ржирзЗрж░ ржоржзрзНржпрзЗ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ
              status = "UPDATED";
            } else if (lastUpdated && lastUpdated < sevenDaysAgo) {
              // рзн ржжрж┐ржирзЗрж░ ржмрзЗрж╢рж┐ ржЖржЧрзЗ ржЖржкржбрзЗржЯ рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирзНрждрзБ ржПржЦржирзЛ ржЖржкржбрзЗржЯ ржХрж░рж╛ ржпрж╛ржпрж╝
              status = "UPDATED";
            }
            // ржЕржирзНржпржерж╛ржпрж╝ ржЦрж╛рж▓рж┐ ржерж╛ржХржмрзЗ
            
            movie.info1_custom = status;
            
            // 2. рж╕ржоржпрж╝рж╕рзНржЯрзНржпрж╛ржорзНржк ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи
            if (!movie.createdAt) {
              movie.createdAt = new Date().toISOString();
            }
            
            if (!movie.lastUpdated) {
              movie.lastUpdated = new Date().toISOString();
            }
            
            // 3. _cacheKey ржпрзБржХрзНржд ржХрж░рзБржи (ржкрзНрж░рждрж┐ ржкрзНрж░рж╕рзЗрж╕рзЗ ржЕржиржирзНржп)
            movie._cacheKey = Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            
            // ржкрзНрж░рзЛржЧрзНрж░рзЗрж╕ рж▓ржЧ
            if ((index + 1) % 10 === 0 || index === movies.length - 1) {
              console.log(`ржкрзНрж░рж╕рзЗрж╕ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ: ${index + 1}/${movies.length} - ${movie.title || 'Unnamed Movie'}: ${status}`);
            }
          });
          
          // 4. рж╕рж╛ржЬрж╛ржирзЛ: ржкрзНрж░ржержорзЗ lastUpdated, рждрж╛рж░ржкрж░ createdAt (ржирждрзБржи/ржЖржкржбрзЗржЯ ржкрзНрж░ржержорзЗ)
          movies.sort((a, b) => {
            const dateA = new Date(a.lastUpdated || a.createdAt || 0);
            const dateB = new Date(b.lastUpdated || b.createdAt || 0);
            return dateB - dateA; // ржЕржмрж░рзЛрж╣рзА ржХрзНрж░ржо
          });
          
          // 5. ржЪрзВржбрж╝рж╛ржирзНржд ржбрзЗржЯрж╛ рж╕рзЗржн ржХрж░рзБржи
          const processedData = {
            _metadata: {
              processedAt: new Date().toISOString(),
              totalMovies: movies.length,
              cacheTimestamp: Date.now(),
              source: "GitHub Actions Processor"
            },
            movies: movies
          };
          
          fs.writeFileSync(outputFile, JSON.stringify(processedData, null, 2), 'utf8');
          console.log(`тЬЕ ржкрзНрж░рж╕рзЗрж╕ ржХрж░рж╛ JSON рж╕рзЗржн ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ: ${outputFile}`);
          console.log(`ЁЯУК ржорзЗржЯрж╛ржбрж╛ржЯрж╛: ${processedData._metadata.totalMovies} movies, processed at ${processedData._metadata.processedAt}`);
          
        } catch (error) {
          console.error("тЭМ JSON ржкрзНрж░рж╕рзЗрж╕рж┐ржВржпрж╝рзЗ рждрзНрж░рзБржЯрж┐:", error.message);
          process.exit(1);
        }
        EOF
        
          # Node.js рж╕рзНржХрзНрж░рж┐ржкрзНржЯ рж░рж╛ржи ржХрж░рзБржи
          node process.js
          
          # ржУрж░рж┐ржЬрж┐ржирж╛рж▓ ржПржмржВ ржкрзНрж░рж╕рзЗрж╕ржб ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ ржЪрзЗржХ ржХрж░рзБржи
          echo "ржУрж░рж┐ржЬрж┐ржирж╛рж▓ ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ: $(stat -c%s data/movies.json) bytes"
          echo "ржкрзНрж░рж╕рзЗрж╕ржб ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ: $(stat -c%s data/movies_processed.json) bytes"
          
        else
          echo "тЭМ movies.json ржлрж╛ржЗрж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐!"
          exit 1
        fi
        
    - name: Commit processed files
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # ржкрж░рж┐ржмрж░рзНрждржи ржХржорж┐ржЯ ржХрж░рзБржи
        git add data/movies_processed.json
        git commit -m "Auto-process movies JSON with dynamic status updates [skip ci]" || echo "No changes to commit"
        
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}
        
    - name: Success Notification
      run: |
        echo "тЬЕ JSON ржкрзНрж░рж╕рзЗрж╕рж┐ржВ рж╕ржлрж▓ржнрж╛ржмрзЗ рж╕ржорзНржкржирзНржи рж╣ржпрж╝рзЗржЫрзЗ!"
        echo "ЁЯФД ржЖржкржбрзЗржЯ ржХрж░рж╛ ржлрж╛ржЗрж▓: data/movies_processed.json"
        echo "ЁЯУЕ ржкрж░ржмрж░рзНрждрзА рж░рж╛ржи: рзйрзж ржорж┐ржирж┐ржЯ ржкрж░рзЗ ржЕржержмрж╛ ржирждрзБржи ржХржорж┐ржЯ рж╣рж▓рзЗ"

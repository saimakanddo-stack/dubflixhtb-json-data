# .github/workflows/update-movies-workflow.yml
name: Daily Update Movie Status

on:
  schedule:
    # ржкрзНрж░рждрж┐ржжрж┐ржи рж░рж╛ржд рззрзиржЯрж╛ рзл ржорж┐ржирж┐ржЯрзЗ (UTC)
    - cron: '5 0 * * *'
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ржЯрзНрж░рж┐ржЧрж╛рж░

jobs:
  update-movies:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: рж░рж┐ржкрзЛржЬрж┐ржЯрж░рж┐ ржЪрзЗржХржЖржЙржЯ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Python рж╕рзЗржЯ ржЖржк ржХрж░рзБржи
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ржПржиржХрзЛржбрж┐ржВ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ рж╕рзЗржЯ ржХрж░рзБржи
      run: |
        # UTF-8 ржПржиржХрзЛржбрж┐ржВ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзБржи
        echo "PYTHONIOENCODING=utf-8" >> $GITHUB_ENV
        echo "LANG=C.UTF-8" >> $GITHUB_ENV
        echo "LC_ALL=C.UTF-8" >> $GITHUB_ENV
    
    - name: ржорзБржнрж┐ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржЖржкржбрзЗржЯ ржХрж░рзБржи
      id: updater
      env:
        PYTHONUTF8: 1
      run: |
        # ржлрж┐ржХрзНрж╕ржб ржнрж╛рж░рзНрж╕ржи рж░рж╛ржи ржХрж░рзБржи
        python scripts/update_movie_status_fixed.py
    
    - name: ржкрж░рж┐ржмрж░рзНрждржи ржЪрзЗржХ ржХрж░рзБржи
      id: check_changes
      run: |
        # ржХрзЛржирзЛ ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝рзЗржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи
        if git diff --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "тД╣я╕П ржХрзЛржирзЛ ржкрж░рж┐ржмрж░рзНрждржи ржирзЗржЗ"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "тЬЕ ржкрж░рж┐ржмрж░рзНрждржи рж╕ржирж╛ржХрзНржд ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ"
          echo "ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд:"
          git diff --stat
        fi
    
    - name: ржкрж░рж┐ржмрж░рзНрждржи ржХржорж┐ржЯ ржПржмржВ ржкрзБрж╢ ржХрж░рзБржи
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        # Git ржХржиржлрж┐ржЧрж╛рж░рзЗрж╢ржи
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
        # UTF-8 рж╕рж╛ржкрзЛрж░рзНржЯ рж╕ржХрзНрж╖ржо ржХрж░рзБржи
        git config --global core.quotepath false
        
        # ржкрж░рж┐ржмрж░рзНрждржи ржпрзЛржЧ ржХрж░рзБржи
        git add data/movies.json
        
        # ржХржорж┐ржЯ ржХрж░рзБржи
        git commit -m 'ЁЯФД Daily Update: Movie status based on date rules'
        
        echo "ржХржорж┐ржЯ рж▓ржЧ:"
        git log --oneline -3
        
        # ржкрзБрж╢ ржХрж░рзБржи (рж░рж┐ржЯрзНрж░рж┐ рж▓ржЬрж┐ржХ рж╕рж╣)
        for attempt in 1 2 3; do
          echo "ржкрзБрж╢ ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ #${attempt}..."
          if git push; then
            echo "тЬЕ ржкрзБрж╢ рж╕ржлрж▓!"
            break
          else
            echo "тЭМ ржкрзБрж╢ ржмрзНржпрж░рзНрже, рзл рж╕рзЗржХрзЗржирзНржб ржкрж░ ржкрзБржирж░рж╛ржпрж╝ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
            sleep 5
            git pull --rebase
          fi
        done
    
    - name: ржХрж╛ржЬ рж╢рзЗрж╖ рж░рж┐ржкрзЛрж░рзНржЯ
      run: |
        echo "========================================="
        echo "      Daily Update рж╕ржорзНржкрзВрж░рзНржг рж╣ржпрж╝рзЗржЫрзЗ       "
        echo "========================================="
        echo "рж╕ржоржпрж╝: $(date)"
        echo "ржкрж░рж┐ржмрж░рзНрждржи: ${{ steps.check_changes.outputs.changes }}"
        echo "========================================="
